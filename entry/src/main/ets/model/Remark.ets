/**
 * å¤‡æ³¨æ•°æ®æ¨¡å‹
 * æ”¯æŒé¥®é£Ÿã€è¿åŠ¨ã€ç”Ÿç†æœŸç­‰å¤šç§ç±»å‹çš„å¤‡æ³¨
 */
import { BusinessConstants } from '../common/Constants';

export enum RemarkType {
  DIET = 'diet',      // é¥®é£Ÿ
  EXERCISE = 'exercise', // è¿åŠ¨
  MENSTRUAL = 'menstrual', // ç”Ÿç†æœŸ
  OTHER = 'other'     // å…¶ä»–
}
export interface ValidationResult {
  isValid: boolean;
  errors: string[];
}

export interface RemarkTypeInfo {
  type: RemarkType;
  displayName: string;
  icon: string;
  color: string;
}

export class Remark {
  id: number;
  recordId: number;  // å…³è”çš„ä½“é‡è®°å½•ID
  type: RemarkType;  // å¤‡æ³¨ç±»å‹
  content: string;   // å¤‡æ³¨å†…å®¹
  timestamp: number; // åˆ›å»º/ä¿®æ”¹æ—¶é—´æˆ³

  constructor(recordId: number, type: RemarkType, content: string, timestamp?: number, id?: number) {
    if (recordId <= 0) {
      throw new Error(`Invalid recordId: ${recordId}. Must be a positive number.`);
    }
    if (!content || content.trim().length === 0) {
      throw new Error(`Content cannot be empty.`);
    }
    if (content.trim().length > BusinessConstants.MAX_REMARK_CONTENT_LENGTH) {
      throw new Error(`Content too long: ${content.length}. Maximum length is ${BusinessConstants.MAX_REMARK_CONTENT_LENGTH}.`);
    }

    this.id = id ?? -1;
    this.recordId = recordId;
    this.type = type;
    this.content = content.trim();
    this.timestamp = timestamp ?? Date.now();
  }

  /**
   * è·å–å¤‡æ³¨ç±»å‹çš„æ˜¾ç¤ºåç§°
   * @returns å¤‡æ³¨ç±»å‹çš„ä¸­æ–‡æ˜¾ç¤ºåç§°
   */
  getTypeDisplayName(): string {
    switch (this.type) {
      case RemarkType.DIET:
        return 'é¥®é£Ÿ';
      case RemarkType.EXERCISE:
        return 'è¿åŠ¨';
      case RemarkType.MENSTRUAL:
        return 'ç”Ÿç†æœŸ';
      case RemarkType.OTHER:
        return 'å…¶ä»–';
      default:
        return 'æœªçŸ¥';
    }
  }

  /**
   * è·å–å¤‡æ³¨ç±»å‹å¯¹åº”çš„é¢œè‰²
   * @returns é¢œè‰²ä»£ç 
   */
  getTypeColor(): string {
    switch (this.type) {
      case RemarkType.DIET:
        return '#4CAF50'; // ç»¿è‰²
      case RemarkType.EXERCISE:
        return '#2196F3'; // è“è‰²
      case RemarkType.MENSTRUAL:
        return '#E91E63'; // ç²‰è‰²
      case RemarkType.OTHER:
        return '#757575'; // ç°è‰²
      default:
        return '#757575';
    }
  }

  /**
   * è·å–å¤‡æ³¨ç±»å‹å¯¹åº”çš„å›¾æ ‡
   * @returns å›¾æ ‡åç§°
   */
  getTypeIcon(): string {
    switch (this.type) {
      case RemarkType.DIET:
        return 'ğŸ½ï¸';
      case RemarkType.EXERCISE:
        return 'ğŸƒ';
      case RemarkType.MENSTRUAL:
        return 'ğŸ©¸';
      case RemarkType.OTHER:
        return 'ğŸ“';
      default:
        return 'ğŸ“';
    }
  }

  /**
   * è·å–æ ¼å¼åŒ–çš„æ—¶é—´å­—ç¬¦ä¸²
   * @returns æ ¼å¼åŒ–çš„æ—¶é—´å­—ç¬¦ä¸²
   */
  getFormattedTimestamp(): string {
    const date = new Date(this.timestamp);
    const year = date.getFullYear();
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const day = date.getDate().toString().padStart(2, '0');
    const hour = date.getHours().toString().padStart(2, '0');
    const minute = date.getMinutes().toString().padStart(2, '0');
    return `${year}/${month}/${day} ${hour}:${minute}`;
  }

  /**
   * æ›´æ–°å¤‡æ³¨å†…å®¹
   * @param newContent æ–°çš„å¤‡æ³¨å†…å®¹
   * @returns æ˜¯å¦æ›´æ–°æˆåŠŸ
   */
  updateContent(newContent: string): boolean {
    if (!newContent || newContent.trim().length === 0) {
      return false;
    }
    if (newContent.trim().length > 200) {
      return false;
    }
    
    this.content = newContent.trim();
    this.timestamp = Date.now();
    return true;
  }

  /**
   * éªŒè¯å¤‡æ³¨æ•°æ®çš„å®Œæ•´æ€§
   * @returns éªŒè¯ç»“æœ
   */
  validate(): ValidationResult {
    const errors: string[] = [];

    if (this.recordId <= 0) {
      errors.push(`Invalid recordId: ${this.recordId}. Must be a positive number.`);
    }

    if (!this.content || this.content.length === 0) {
      errors.push('Content cannot be empty.');
    }

    if (this.content.length > 200) {
      errors.push(`Content too long: ${this.content.length}. Maximum length is 200.`);
    }

    if (this.timestamp <= 0) {
      errors.push(`Invalid timestamp: ${this.timestamp}. Must be a positive number.`);
    }

    if (this.timestamp > Date.now()) {
      errors.push('Timestamp cannot be in the future.');
    }

    const result: ValidationResult = {
      isValid: errors.length === 0,
      errors
    };

    return result;
  }
  /**
   * è·å–æ‰€æœ‰å¯ç”¨çš„å¤‡æ³¨ç±»å‹
   * @returns å¤‡æ³¨ç±»å‹æ•°ç»„
   */
  static getAllTypes(): RemarkTypeInfo[] {
    return [
      {
        type: RemarkType.DIET,
        displayName: 'é¥®é£Ÿ',
        icon: 'ğŸ½ï¸',
        color: '#4CAF50'
      },
      {
        type: RemarkType.EXERCISE,
        displayName: 'è¿åŠ¨',
        icon: 'ğŸƒ',
        color: '#2196F3'
      },
      {
        type: RemarkType.MENSTRUAL,
        displayName: 'ç”Ÿç†æœŸ',
        icon: 'ğŸ©¸',
        color: '#E91E63'
      },
      {
        type: RemarkType.OTHER,
        displayName: 'å…¶ä»–',
        icon: 'ğŸ“',
        color: '#757575'
      }
    ];
  }
}